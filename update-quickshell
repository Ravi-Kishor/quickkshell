#!/bin/bash
set -euo pipefail

REPO="Ravi-Kishor/quickkshell"
PKG_NAME="quickshell-git"

require() {
  command -v "$1" >/dev/null || {
    echo "‚ùå Required command '$1' not found"
    exit 1
  }
}

require curl
require jq
require sudo
require pacman

get_installed_version() {
  pacman -Q "$PKG_NAME" 2>/dev/null | awk '{print $2}' || echo "Not Installed"
}

INSTALLED_VERSION=$(get_installed_version)

echo "Installed version: $INSTALLED_VERSION"
echo "üì° Fetching latest release metadata‚Ä¶"

RELEASE_JSON=$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest")

TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
echo "Latest release tag: $TAG_NAME"

ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '
  .assets[]
  | select(.name | test("^quickshell-git-.*-x86_64\\.pkg\\.tar\\.zst$"))
  | .browser_download_url
')

if [[ -z "$ASSET_URL" || "$ASSET_URL" == "null" ]]; then
  echo "‚ùå Could not find quickshell package in release $TAG_NAME"
  exit 1
fi

PKG_FILE=$(basename "$ASSET_URL")
LATEST_VERSION=$(echo "$PKG_FILE" | sed -E 's/^quickshell-git-([^-]+)-.*/\1/')

echo "Latest package version: $LATEST_VERSION"
echo

if [[ "$INSTALLED_VERSION" == "$LATEST_VERSION" ]]; then
  echo "‚úÖ Already up to date"
  exit 0
fi

TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"

echo "üì• Downloading $PKG_FILE"
curl -L --fail -o "$PKG_FILE" "$ASSET_URL"

echo "üì¶ Installing package..."
sudo pacman -U --noconfirm "$PKG_FILE"

cd /
rm -rf "$TMP_DIR"

echo
echo "‚úÖ quickshell-git $LATEST_VERSION installed successfully!"
