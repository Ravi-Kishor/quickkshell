name: Build niri-git (CachyOS)

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      # -------------------------
      # Base update
      # -------------------------
      - name: Update base system
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git curl sudo

      # -------------------------
      # Add CachyOS repo
      # -------------------------
      - name: Setup CachyOS repo
        run: |
          pacman-key --init
          curl -L https://mirror.cachyos.org/cachyos-repo.tar.xz -o cachyos-repo.tar.xz
          tar -xf cachyos-repo.tar.xz
          cd cachyos-repo
          chmod +x cachyos-repo.sh
          yes | ./cachyos-repo.sh
          pacman -Syu --noconfirm

      # -------------------------
      # Install dependencies
      # -------------------------
      - name: Install dependencies
        run: |
          pacman -S --noconfirm \
            cairo glib2 libdisplay-info libinput libpipewire libxkbcommon \
            mesa pango pixman seatd systemd-libs \
            wayland wayland-protocols \
            xdg-desktop-portal pipewire \
            clang rust

      # -------------------------
      # Create builder user
      # -------------------------
      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      # -------------------------
      # Create PKGBUILD
      # -------------------------
      - name: Create PKGBUILD
        run: |
          cat > /home/builder/PKGBUILD << 'EOF'
          pkgname=niri-git
          pkgver=0
          pkgrel=1
          pkgdesc="Scrollable-tiling Wayland compositor (git)"
          arch=(x86_64)
          url="https://github.com/YaLTeR/niri"
          license=(GPL-3.0-or-later)

          depends=(
            cairo glib2 libdisplay-info libinput libpipewire
            libxkbcommon mesa pango pixman seatd systemd-libs
            xdg-desktop-portal pipewire
          )

          makedepends=(clang rust git)

          provides=(niri)
          conflicts=(niri)

          options=(!debug)

          source=("niri::git+$url.git")
          sha256sums=('SKIP')

          pkgver() {
            cd niri
            git describe --long --tags --abbrev=7 \
              | sed 's/^v//;s/-/.r/;s/-/./'
          }

          build() {
            cd niri
            cargo fetch --locked
            cargo build --frozen --release
          }

          package() {
            cd niri
            install -Dm755 target/release/niri -t "$pkgdir/usr/bin/"
            install -Dm755 resources/niri-session -t "$pkgdir/usr/bin/"
            install -Dm644 resources/niri{.service,-shutdown.target} -t "$pkgdir/usr/lib/systemd/user/"
            install -Dm644 resources/niri.desktop -t "$pkgdir/usr/share/wayland-sessions/"
            install -Dm644 resources/niri-portals.conf -t "$pkgdir/usr/share/xdg-desktop-portal/"
            install -Dm644 resources/default-config.kdl README.md -t "$pkgdir/usr/share/doc/niri/"
          }
          EOF

      # -------------------------
      # Build package
      # -------------------------
      - name: Build niri-git
        run: |
          chown -R builder:builder /home/builder
          su builder -c "cd ~ && makepkg -s --noconfirm"

      # -------------------------
      # Upload artifact
      # -------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: niri-git
          path: /home/builder/*.pkg.tar.zst
