name: Build quickshell-git

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/archlinux/archlinux:latest

    steps:
      # -------------------------
      # Base system
      # -------------------------
      - name: Update base system
        run: |
          pacman -Syyu --noconfirm
          pacman -S --noconfirm base-devel git sudo curl tar

      # -------------------------
      # Setup CachyOS repo
      # -------------------------
      - name: Setup CachyOS repo
        run: |
          pacman-key --init
          curl -L https://mirror.cachyos.org/cachyos-repo.tar.xz -o cachyos-repo.tar.xz
          tar -xf cachyos-repo.tar.xz
          cd cachyos-repo
          chmod +x cachyos-repo.sh
          yes | ./cachyos-repo.sh
          pacman -Syyu --noconfirm

      # -------------------------
      # Force Release + Strip + v3
      # -------------------------
      - name: Configure build flags
        run: |
          # Enable stripping
          sed -i 's/^OPTIONS=.*/OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge debug)/' /etc/makepkg.conf

          # Clear debug flags
          sed -i 's/^DEBUG_CFLAGS=.*/DEBUG_CFLAGS=""/' /etc/makepkg.conf
          sed -i 's/^DEBUG_CXXFLAGS=.*/DEBUG_CXXFLAGS=""/' /etc/makepkg.conf

          # Force v3 optimization
          sed -i 's/-march=x86-64/-march=x86-64-v3/' /etc/makepkg.conf

      # -------------------------
      # Create builder user
      # -------------------------
      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      # -------------------------
      # Install paru
      # -------------------------
      - name: Install paru
        run: |
          pacman -S --noconfirm paru

      # -------------------------
      # Build quickshell-git
      # -------------------------
      - name: Build quickshell-git
        run: |
          su builder -c "paru -S --noconfirm --needed quickshell-git"

      # -------------------------
      # Extract version + prepare release
      # -------------------------
      - name: Prepare release
        id: pkg
        run: |
          PKG_PATH=$(ls /home/builder/.cache/paru/clone/quickshell-git/*.pkg.tar.zst)
          PKG_FILE=$(basename "$PKG_PATH")
          VERSION=$(echo "$PKG_FILE" | sed -E 's/^quickshell-git-(.*)-x86_64\.pkg\.tar\.zst/\1/')
          echo "Detected version: $VERSION"
          mkdir release
          cp "$PKG_PATH" release/
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -------------------------
      # Upload artifact (optional)
      # -------------------------
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickshell-git-${{ steps.pkg.outputs.version }}
          path: release/*.pkg.tar.zst

      # -------------------------
      # Create GitHub Release
      # -------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pkg.outputs.version }}
          name: quickshell-git ${{ steps.pkg.outputs.version }}
          files: release/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
